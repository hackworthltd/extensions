name: chelsio-firmware
variant: scratch
shell: /toolchain/bin/bash
dependencies:
  - stage: base
  # Our linux-firmware build is incredibly slow, or stuck. Use upstream.
  #- image: "{{ .PKGS_PREFIX }}/linux-firmware:{{ .BUILD_ARG_PKGS }}"
  - image: "ghcr.io/siderolabs/linux-firmware:v1.5.0-9-g7f9d6eb"
steps:
  - prepare:
      - |
        sed -i 's#$VERSION#{{ .VERSION }}#' /pkg/manifest.yaml
    install:
      - |
        mkdir -p /rootfs/lib/firmware
        cp -R -p /lib/firmware/cxgb3 /rootfs/lib/firmware
        cp -R -p /lib/firmware/cxgb4 /rootfs/lib/firmware
finalize:
  - from: /rootfs
    to: /rootfs
  - from: /pkg/manifest.yaml
    to: /
